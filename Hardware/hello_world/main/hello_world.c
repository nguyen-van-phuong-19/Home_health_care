#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/i2c.h"
#include <string.h>

// I2C configuration
#define I2C_PORT            I2C_NUM_0
#define I2C_SDA_IO          6
#define I2C_SCL_IO          7
#define I2C_FREQ_HZ         400000

// SSD1306 I2C address
#define SSD1306_ADDR        0x3C

// Display size
#define WIDTH               128
#define HEIGHT              64
#define PAGES               (HEIGHT/8)

// Buffer for display
static uint8_t ssd1306_buffer[WIDTH * PAGES];

// ----- Font 5×7 (chỉ map từ ký tự 32–127), mỗi ký tự 5 cột -----
// Dữ liệu tham khảo nhiều nơi, ở đây rút gọn ví dụ bản chuẩn:
static const uint8_t font5x7[][5] = {
// first row defines - FONTWIDTH, FONTHEIGHT, ASCII START CHAR, TOTAL CHARACTERS, FONT MAP WIDTH HIGH, FONT MAP WIDTH LOW (2,56 meaning 256)
    {5,8,0,255,12,75},
    {0x00, 0x00, 0x00, 0x00, 0x00},
    {0x3E, 0x5B, 0x4F, 0x5B, 0x3E},
    {0x3E, 0x6B, 0x4F, 0x6B, 0x3E},
    {0x1C, 0x3E, 0x7C, 0x3E, 0x1C},
    {0x18, 0x3C, 0x7E, 0x3C, 0x18},
    {0x1C, 0x57, 0x7D, 0x57, 0x1C},
    {0x1C, 0x5E, 0x7F, 0x5E, 0x1C},
    {0x00, 0x18, 0x3C, 0x18, 0x00},
    {0xFF, 0xE7, 0xC3, 0xE7, 0xFF},
    {0x00, 0x18, 0x24, 0x18, 0x00},
    {0xFF, 0xE7, 0xDB, 0xE7, 0xFF},
    {0x30, 0x48, 0x3A, 0x06, 0x0E},
    {0x26, 0x29, 0x79, 0x29, 0x26},
    {0x40, 0x7F, 0x05, 0x05, 0x07},
    {0x40, 0x7F, 0x05, 0x25, 0x3F},
    {0x5A, 0x3C, 0xE7, 0x3C, 0x5A},
    {0x7F, 0x3E, 0x1C, 0x1C, 0x08},
    {0x08, 0x1C, 0x1C, 0x3E, 0x7F},
    {0x14, 0x22, 0x7F, 0x22, 0x14},
    {0x5F, 0x5F, 0x00, 0x5F, 0x5F},
    {0x06, 0x09, 0x7F, 0x01, 0x7F},
    {0x00, 0x66, 0x89, 0x95, 0x6A},
    {0x60, 0x60, 0x60, 0x60, 0x60},
    {0x94, 0xA2, 0xFF, 0xA2, 0x94},
    {0x08, 0x04, 0x7E, 0x04, 0x08},
    {0x10, 0x20, 0x7E, 0x20, 0x10},
    {0x08, 0x08, 0x2A, 0x1C, 0x08},
    {0x08, 0x1C, 0x2A, 0x08, 0x08},
    {0x1E, 0x10, 0x10, 0x10, 0x10},
    {0x0C, 0x1E, 0x0C, 0x1E, 0x0C},
    {0x30, 0x38, 0x3E, 0x38, 0x30},
    {0x06, 0x0E, 0x3E, 0x0E, 0x06},
    {0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x5F, 0x00, 0x00},
    {0x00, 0x07, 0x00, 0x07, 0x00},
    {0x14, 0x7F, 0x14, 0x7F, 0x14},
    {0x24, 0x2A, 0x7F, 0x2A, 0x12},
    {0x23, 0x13, 0x08, 0x64, 0x62},
    {0x36, 0x49, 0x56, 0x20, 0x50},
    {0x00, 0x08, 0x07, 0x03, 0x00},
    {0x00, 0x1C, 0x22, 0x41, 0x00},
    {0x00, 0x41, 0x22, 0x1C, 0x00},
    {0x2A, 0x1C, 0x7F, 0x1C, 0x2A},
    {0x08, 0x08, 0x3E, 0x08, 0x08},
    {0x00, 0x80, 0x70, 0x30, 0x00},
    {0x08, 0x08, 0x08, 0x08, 0x08},
    {0x00, 0x00, 0x60, 0x60, 0x00},
    {0x20, 0x10, 0x08, 0x04, 0x02},
    {0x3E, 0x51, 0x49, 0x45, 0x3E},
    {0x00, 0x42, 0x7F, 0x40, 0x00},
    {0x72, 0x49, 0x49, 0x49, 0x46},
    {0x21, 0x41, 0x49, 0x4D, 0x33},
    {0x18, 0x14, 0x12, 0x7F, 0x10},
    {0x27, 0x45, 0x45, 0x45, 0x39},
    {0x3C, 0x4A, 0x49, 0x49, 0x31},
    {0x41, 0x21, 0x11, 0x09, 0x07},
    {0x36, 0x49, 0x49, 0x49, 0x36},
    {0x46, 0x49, 0x49, 0x29, 0x1E},
    {0x00, 0x00, 0x14, 0x00, 0x00},
    {0x00, 0x40, 0x34, 0x00, 0x00},
    {0x00, 0x08, 0x14, 0x22, 0x41},
    {0x14, 0x14, 0x14, 0x14, 0x14},
    {0x00, 0x41, 0x22, 0x14, 0x08},
    {0x02, 0x01, 0x59, 0x09, 0x06},
    {0x3E, 0x41, 0x5D, 0x59, 0x4E},
    {0x7C, 0x12, 0x11, 0x12, 0x7C},
    {0x7F, 0x49, 0x49, 0x49, 0x36},
    {0x3E, 0x41, 0x41, 0x41, 0x22},
    {0x7F, 0x41, 0x41, 0x41, 0x3E},
    {0x7F, 0x49, 0x49, 0x49, 0x41},
    {0x7F, 0x09, 0x09, 0x09, 0x01},
    {0x3E, 0x41, 0x41, 0x51, 0x73},
    {0x7F, 0x08, 0x08, 0x08, 0x7F},
    {0x00, 0x41, 0x7F, 0x41, 0x00},
    {0x20, 0x40, 0x41, 0x3F, 0x01},
    {0x7F, 0x08, 0x14, 0x22, 0x41},
    {0x7F, 0x40, 0x40, 0x40, 0x40},
    {0x7F, 0x02, 0x1C, 0x02, 0x7F},
    {0x7F, 0x04, 0x08, 0x10, 0x7F},
    {0x3E, 0x41, 0x41, 0x41, 0x3E},
    {0x7F, 0x09, 0x09, 0x09, 0x06},
    {0x3E, 0x41, 0x51, 0x21, 0x5E},
    {0x7F, 0x09, 0x19, 0x29, 0x46},
    {0x26, 0x49, 0x49, 0x49, 0x32},
    {0x03, 0x01, 0x7F, 0x01, 0x03},
    {0x3F, 0x40, 0x40, 0x40, 0x3F},
    {0x1F, 0x20, 0x40, 0x20, 0x1F},
    {0x3F, 0x40, 0x38, 0x40, 0x3F},
    {0x63, 0x14, 0x08, 0x14, 0x63},
    {0x03, 0x04, 0x78, 0x04, 0x03},
    {0x61, 0x59, 0x49, 0x4D, 0x43},
    {0x00, 0x7F, 0x41, 0x41, 0x41},
    {0x02, 0x04, 0x08, 0x10, 0x20},
    {0x00, 0x41, 0x41, 0x41, 0x7F},
    {0x04, 0x02, 0x01, 0x02, 0x04},
    {0x40, 0x40, 0x40, 0x40, 0x40},
    {0x00, 0x03, 0x07, 0x08, 0x00},
    {0x20, 0x54, 0x54, 0x78, 0x40},
    {0x7F, 0x28, 0x44, 0x44, 0x38},
    {0x38, 0x44, 0x44, 0x44, 0x28},
    {0x38, 0x44, 0x44, 0x28, 0x7F},
    {0x38, 0x54, 0x54, 0x54, 0x18},
    {0x00, 0x08, 0x7E, 0x09, 0x02},
    {0x18, 0xA4, 0xA4, 0x9C, 0x78},
    {0x7F, 0x08, 0x04, 0x04, 0x78},
    {0x00, 0x44, 0x7D, 0x40, 0x00},
    {0x20, 0x40, 0x40, 0x3D, 0x00},
    {0x7F, 0x10, 0x28, 0x44, 0x00},
    {0x00, 0x41, 0x7F, 0x40, 0x00},
    {0x7C, 0x04, 0x78, 0x04, 0x78},
    {0x7C, 0x08, 0x04, 0x04, 0x78},
    {0x38, 0x44, 0x44, 0x44, 0x38},
    {0xFC, 0x18, 0x24, 0x24, 0x18},
    {0x18, 0x24, 0x24, 0x18, 0xFC},
    {0x7C, 0x08, 0x04, 0x04, 0x08},
    {0x48, 0x54, 0x54, 0x54, 0x24},
    {0x04, 0x04, 0x3F, 0x44, 0x24},
    {0x3C, 0x40, 0x40, 0x20, 0x7C},
    {0x1C, 0x20, 0x40, 0x20, 0x1C},
    {0x3C, 0x40, 0x30, 0x40, 0x3C},
    {0x44, 0x28, 0x10, 0x28, 0x44},
    {0x4C, 0x90, 0x90, 0x90, 0x7C},
    {0x44, 0x64, 0x54, 0x4C, 0x44},
    {0x00, 0x08, 0x36, 0x41, 0x00},
    {0x00, 0x00, 0x77, 0x00, 0x00},
    {0x00, 0x41, 0x36, 0x08, 0x00},
    {0x02, 0x01, 0x02, 0x04, 0x02},
    {0x3C, 0x26, 0x23, 0x26, 0x3C},
    {0x1E, 0xA1, 0xA1, 0x61, 0x12},
    {0x3A, 0x40, 0x40, 0x20, 0x7A},
    {0x38, 0x54, 0x54, 0x55, 0x59},
    {0x21, 0x55, 0x55, 0x79, 0x41},
    {0x21, 0x54, 0x54, 0x78, 0x41},
    {0x21, 0x55, 0x54, 0x78, 0x40},
    {0x20, 0x54, 0x55, 0x79, 0x40},
    {0x0C, 0x1E, 0x52, 0x72, 0x12},
    {0x39, 0x55, 0x55, 0x55, 0x59},
    {0x39, 0x54, 0x54, 0x54, 0x59},
    {0x39, 0x55, 0x54, 0x54, 0x58},
    {0x00, 0x00, 0x45, 0x7C, 0x41},
    {0x00, 0x02, 0x45, 0x7D, 0x42},
    {0x00, 0x01, 0x45, 0x7C, 0x40},
    {0xF0, 0x29, 0x24, 0x29, 0xF0},
    {0xF0, 0x28, 0x25, 0x28, 0xF0},
    {0x7C, 0x54, 0x55, 0x45, 0x00},
    {0x20, 0x54, 0x54, 0x7C, 0x54},
    {0x7C, 0x0A, 0x09, 0x7F, 0x49},
    {0x32, 0x49, 0x49, 0x49, 0x32},
    {0x32, 0x48, 0x48, 0x48, 0x32},
    {0x32, 0x4A, 0x48, 0x48, 0x30},
    {0x3A, 0x41, 0x41, 0x21, 0x7A},
    {0x3A, 0x42, 0x40, 0x20, 0x78},
    {0x00, 0x9D, 0xA0, 0xA0, 0x7D},
    {0x39, 0x44, 0x44, 0x44, 0x39},
    {0x3D, 0x40, 0x40, 0x40, 0x3D},
    {0x3C, 0x24, 0xFF, 0x24, 0x24},
    {0x48, 0x7E, 0x49, 0x43, 0x66},
    {0x2B, 0x2F, 0xFC, 0x2F, 0x2B},
    {0xFF, 0x09, 0x29, 0xF6, 0x20},
    {0xC0, 0x88, 0x7E, 0x09, 0x03},
    {0x20, 0x54, 0x54, 0x79, 0x41},
    {0x00, 0x00, 0x44, 0x7D, 0x41},
    {0x30, 0x48, 0x48, 0x4A, 0x32},
    {0x38, 0x40, 0x40, 0x22, 0x7A},
    {0x00, 0x7A, 0x0A, 0x0A, 0x72},
    {0x7D, 0x0D, 0x19, 0x31, 0x7D},
    {0x26, 0x29, 0x29, 0x2F, 0x28},
    {0x26, 0x29, 0x29, 0x29, 0x26},
    {0x30, 0x48, 0x4D, 0x40, 0x20},
    {0x38, 0x08, 0x08, 0x08, 0x08},
    {0x08, 0x08, 0x08, 0x08, 0x38},
    {0x2F, 0x10, 0xC8, 0xAC, 0xBA},
    {0x2F, 0x10, 0x28, 0x34, 0xFA},
    {0x00, 0x00, 0x7B, 0x00, 0x00},
    {0x08, 0x14, 0x2A, 0x14, 0x22},
    {0x22, 0x14, 0x2A, 0x14, 0x08},
    {0xAA, 0x00, 0x55, 0x00, 0xAA},
    {0xAA, 0x55, 0xAA, 0x55, 0xAA},
    {0x00, 0x00, 0x00, 0xFF, 0x00},
    {0x10, 0x10, 0x10, 0xFF, 0x00},
    {0x14, 0x14, 0x14, 0xFF, 0x00},
    {0x10, 0x10, 0xFF, 0x00, 0xFF},
    {0x10, 0x10, 0xF0, 0x10, 0xF0},
    {0x14, 0x14, 0x14, 0xFC, 0x00},
    {0x14, 0x14, 0xF7, 0x00, 0xFF},
    {0x00, 0x00, 0xFF, 0x00, 0xFF},
    {0x14, 0x14, 0xF4, 0x04, 0xFC},
    {0x14, 0x14, 0x17, 0x10, 0x1F},
    {0x10, 0x10, 0x1F, 0x10, 0x1F},
    {0x14, 0x14, 0x14, 0x1F, 0x00},
    {0x10, 0x10, 0x10, 0xF0, 0x00},
    {0x00, 0x00, 0x00, 0x1F, 0x10},
    {0x10, 0x10, 0x10, 0x1F, 0x10},
    {0x10, 0x10, 0x10, 0xF0, 0x10},
    {0x00, 0x00, 0x00, 0xFF, 0x10},
    {0x10, 0x10, 0x10, 0x10, 0x10},
    {0x10, 0x10, 0x10, 0xFF, 0x10},
    {0x00, 0x00, 0x00, 0xFF, 0x14},
    {0x00, 0x00, 0xFF, 0x00, 0xFF},
    {0x00, 0x00, 0x1F, 0x10, 0x17},
    {0x00, 0x00, 0xFC, 0x04, 0xF4},
    {0x14, 0x14, 0x17, 0x10, 0x17},
    {0x14, 0x14, 0xF4, 0x04, 0xF4},
    {0x00, 0x00, 0xFF, 0x00, 0xF7},
    {0x14, 0x14, 0x14, 0x14, 0x14},
    {0x14, 0x14, 0xF7, 0x00, 0xF7},
    {0x14, 0x14, 0x14, 0x17, 0x14},
    {0x10, 0x10, 0x1F, 0x10, 0x1F},
    {0x14, 0x14, 0x14, 0xF4, 0x14},
    {0x10, 0x10, 0xF0, 0x10, 0xF0},
    {0x00, 0x00, 0x1F, 0x10, 0x1F},
    {0x00, 0x00, 0x00, 0x1F, 0x14},
    {0x00, 0x00, 0x00, 0xFC, 0x14},
    {0x00, 0x00, 0xF0, 0x10, 0xF0},
    {0x10, 0x10, 0xFF, 0x10, 0xFF},
    {0x14, 0x14, 0x14, 0xFF, 0x14},
    {0x10, 0x10, 0x10, 0x1F, 0x00},
    {0x00, 0x00, 0x00, 0xF0, 0x10},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xF0, 0xF0, 0xF0, 0xF0, 0xF0},
    {0xFF, 0xFF, 0xFF, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0xFF, 0xFF},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F},
    {0x38, 0x44, 0x44, 0x38, 0x44},
    {0x7C, 0x2A, 0x2A, 0x3E, 0x14},
    {0x7E, 0x02, 0x02, 0x06, 0x06},
    {0x02, 0x7E, 0x02, 0x7E, 0x02},
    {0x63, 0x55, 0x49, 0x41, 0x63},
    {0x38, 0x44, 0x44, 0x3C, 0x04},
    {0x40, 0x7E, 0x20, 0x1E, 0x20},
    {0x06, 0x02, 0x7E, 0x02, 0x02},
    {0x99, 0xA5, 0xE7, 0xA5, 0x99},
    {0x1C, 0x2A, 0x49, 0x2A, 0x1C},
    {0x4C, 0x72, 0x01, 0x72, 0x4C},
    {0x30, 0x4A, 0x4D, 0x4D, 0x30},
    {0x30, 0x48, 0x78, 0x48, 0x30},
    {0xBC, 0x62, 0x5A, 0x46, 0x3D},
    {0x3E, 0x49, 0x49, 0x49, 0x00},
    {0x7E, 0x01, 0x01, 0x01, 0x7E},
    {0x2A, 0x2A, 0x2A, 0x2A, 0x2A},
    {0x44, 0x44, 0x5F, 0x44, 0x44},
    {0x40, 0x51, 0x4A, 0x44, 0x40},
    {0x40, 0x44, 0x4A, 0x51, 0x40},
    {0x00, 0x00, 0xFF, 0x01, 0x03},
    {0xE0, 0x80, 0xFF, 0x00, 0x00},
    {0x08, 0x08, 0x6B, 0x6B, 0x08},
    {0x36, 0x12, 0x36, 0x24, 0x36},
    {0x06, 0x0F, 0x09, 0x0F, 0x06},
    {0x00, 0x00, 0x18, 0x18, 0x00},
    {0x00, 0x00, 0x10, 0x10, 0x00},
    {0x30, 0x40, 0xFF, 0x01, 0x01},
    {0x00, 0x1F, 0x01, 0x01, 0x1E},
    {0x00, 0x19, 0x1D, 0x17, 0x12},
    {0x00, 0x3C, 0x3C, 0x3C, 0x3C},
    {0x00, 0x00, 0x00, 0x00, 0x00},
};

// ----- I2C helper -----
static esp_err_t i2c_write(uint8_t control, const uint8_t* data, size_t len) {
    i2c_cmd_handle_t cmd = i2c_cmd_link_create();
    i2c_master_start(cmd);
    // Địa chỉ + write bit
    i2c_master_write_byte(cmd, (SSD1306_ADDR<<1) | I2C_MASTER_WRITE, true);
    // Control byte: 0x00 = lệnh, 0x40 = data
    i2c_master_write_byte(cmd, control, true);
    i2c_master_write(cmd, data, len, true);
    i2c_master_stop(cmd);
    esp_err_t ret = i2c_master_cmd_begin(I2C_PORT, cmd, pdMS_TO_TICKS(1000));
    i2c_cmd_link_delete(cmd);
    return ret;
}

// Gửi 1 lệnh
static inline esp_err_t ssd1306_send_cmd(uint8_t cmd) {
    return i2c_write(0x00, &cmd, 1);
}
// Gửi nhiều data
static inline esp_err_t ssd1306_send_data(const uint8_t* data, size_t len) {
    return i2c_write(0x40, data, len);
}

// ----- Khởi tạo I2C bus -----
static void i2c_master_init(void) {
    i2c_config_t conf = {
        .mode = I2C_MODE_MASTER,
        .sda_io_num = I2C_SDA_IO,
        .scl_io_num = I2C_SCL_IO,
        .sda_pullup_en = GPIO_PULLUP_ENABLE,
        .scl_pullup_en = GPIO_PULLUP_ENABLE,
        .master.clk_speed = I2C_FREQ_HZ,
    };
    ESP_ERROR_CHECK(i2c_param_config(I2C_PORT, &conf));
    ESP_ERROR_CHECK(i2c_driver_install(I2C_PORT, I2C_MODE_MASTER, 0, 0, 0));
}

// ----- SSD1306 init sequence -----
static void ssd1306_init(void) {
    // theo datasheet SSD1306
    uint8_t init_seq[] = {
        0xAE,             // DISPLAYOFF
        0x20, 0x00,       // SET MEMORY MODE 0x00 horizontal
        0xB0,             // SET PAGE START ADDRESS for page addressing mode
        0xC8,             // COM OUTPUT SCAN DIR remapped
        0x00,             // SET LOW COLUMN
        0x10,             // SET HIGH COLUMN
        0x40,             // SET START LINE =0
        0x81, 0x7F,       // SET CONTRAST
        0xA1,             // SEGREMAP
        0xA6,             // NORMAL DISPLAY
        0xA8, HEIGHT - 1, // SET MULTIPLEX
        0xA4,             // DISPLAY RAM
        0xD3, 0x00,       // SET DISPLAY OFFSET
        0xD5, 0x80,       // SET DISPLAY CLOCK DIV
        0xD9, 0xF1,       // SET PRE-CHARGE
        0xDA, 0x12,       // SET COM PINS
        0xDB, 0x40,       // SET VCOM DETECT
        0x8D, 0x14,       // CHARGE PUMP ENABLE
        0xAF              // DISPLAY ON
    };
    for (size_t i = 0; i < sizeof(init_seq); i++) {
        ESP_ERROR_CHECK(ssd1306_send_cmd(init_seq[i]));
    }
}

// ----- Làm sạch buffer và màn -----
static void ssd1306_clear(void) {
    memset(ssd1306_buffer, 0, sizeof(ssd1306_buffer));
    // push toàn bộ buffer
    for (uint8_t page = 0; page < PAGES; page++) {
        ESP_ERROR_CHECK(ssd1306_send_cmd(0xB0 + page)); // set page
        ESP_ERROR_CHECK(ssd1306_send_cmd(0x00));        // col low
        ESP_ERROR_CHECK(ssd1306_send_cmd(0x10));        // col high
        ssd1306_send_data(&ssd1306_buffer[page*WIDTH], WIDTH);
    }
}

// ----- Vẽ ký tự 5×7 tại vị trí (x, page) -----
static void ssd1306_draw_char(uint8_t x, uint8_t page, char c) {
    if (c < 32 || c > 127) c = '?';
    const uint8_t *ch = font5x7[c - 32];
    // mỗi ký tự 5 cột + 1 cột khoảng cách
    for (int i = 0; i < 6; i++) {
        uint8_t col = (i < 5) ? ch[i] : 0x00;
        // cập nhật buffer
        ssd1306_buffer[page*WIDTH + x + i] = col;
    }
}

// ----- Vẽ chuỗi ngang trên cùng 1 page -----
static void ssd1306_draw_string(uint8_t x, uint8_t page, const char* str) {
    while (*str) {
        ssd1306_draw_char(x, page, *str++);
        x += 6;
        if (x + 6 > WIDTH) break;
    }
}

// ----- Đẩy buffer hiển thị -----
static void ssd1306_refresh(void) {
    for (uint8_t page = 0; page < PAGES; page++) {
        ESP_ERROR_CHECK(ssd1306_send_cmd(0xB0 + page));
        ESP_ERROR_CHECK(ssd1306_send_cmd(0x00));
        ESP_ERROR_CHECK(ssd1306_send_cmd(0x10));
        ssd1306_send_data(&ssd1306_buffer[page*WIDTH], WIDTH);
    }
}

// ----- app_main -----
void app_main(void) {
    i2c_master_init();
    ssd1306_init();
    ssd1306_clear();

    // In "Hello, World!" bắt đầu tại (0,0):
    ssd1306_draw_string(0, 0, "Hello, World!");

    ssd1306_refresh();

    // Giữ chương trình chạy
    while (1) {
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}
